#!/bin/sh
THIS_PROJECT=`pwd`/`dirname $0`/..

BUILD_HOME=/tmp/myenergy-pages-build-`date +'%s'`
mkdir $BUILD_HOME
echo "BUILD_HOME: $BUILD_HOME"

$THIS_PROJECT/bin/flutterflow-export
cp -rf $THIS_PROJECT/flutterflow-export/* $BUILD_HOME/.
cd $BUILD_HOME

echo "\nBuilding for web ..."
flutter build web

echo "\nApplying patches ..."
PATCHES=$THIS_PROJECT/patches/github-pages

HTML=build/web/index.html
echo "\nPatch $HTML adding leading '/'s ...\n"
cd build/web
patch -R -p0 < $PATCHES/index.html.patch 
cd - > /dev/null

echo "\nAdding SPA github pages snippet to $HTML ..."
SPLIT_LINE_NUM=`grep -n "</head>" $HTML | cut -d: -f1`
NUM_LINES=`wc -l $HTML | cut -d" " -f1`

NEW_HTML=$HTML.new
head -`expr $SPLIT_LINE_NUM - 1` $HTML > $NEW_HTML
cat $PATCHES/gh-pages-hack-snippet.html >> $NEW_HTML
tail -`expr $NUM_LINES - $SPLIT_LINE_NUM + 1` $HTML >> $NEW_HTML
mv $NEW_HTML $HTML

GH_PAGES_HOME=$THIS_PROJECT/../simt-myenergy-gh-pages
echo "\nCopying build/web to $GH_PAGES_HOME ..."
rm -rf $GH_PAGES_HOME/*
cp -r build/web/* $GH_PAGES_HOME
cd $GH_PAGES_HOME

# we blow away everything before copying over the flutter app
# but we want the following files as customizations and addons:
git restore README.md manifest.json CNAME 404.html favicon.png favicon.ico

git status
