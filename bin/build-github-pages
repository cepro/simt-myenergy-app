#!/bin/sh
THIS_PROJECT=`pwd`/`dirname $0`/..
PATCHES=$THIS_PROJECT/patches

BUILD_HOME=/tmp/myenergy-pages-build-`date +'%s'`
mkdir $BUILD_HOME
echo "BUILD_HOME: $BUILD_HOME"

$THIS_PROJECT/bin/flutterflow-export || exit 1
cp -rf $THIS_PROJECT/flutterflow-export/* $BUILD_HOME/.
cd $BUILD_HOME

echo "Fix Patch 1: fix for gh://FlutterFlow/flutterflow-issues #1471 ...\n"
patch -p0 < $PATCHES/fixes/fix-flutterflow-github-issue-1471.patch || exit 1

echo "Building for web ...\n"
flutter build web || exit 1

cd build/web

echo "\nGithub Pages Patch 1: add leading '/'s ...\n"
patch -R -p0 < $PATCHES/github-pages/index.html.patch || exit 1

echo "\nGithub Pages Patch 2: apply SPA 404 redirect hack ...\n"
patch    -p0 < $PATCHES/github-pages/gh-pages-hack-snippet.html.patch || exit 1

cd - > /dev/null

GH_PAGES_HOME=$THIS_PROJECT/../simt-myenergy-gh-pages
echo "\nCopying build/web to $GH_PAGES_HOME ..."
rm -rf $GH_PAGES_HOME/*
cp -r build/web/* $GH_PAGES_HOME
cd $GH_PAGES_HOME

# we blow away everything before copying over the flutter app
# but we want the following files as customizations and addons:
git restore README.md manifest.json CNAME 404.html favicon.png favicon.ico

git status
