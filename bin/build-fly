#!/bin/sh

set -e

if [ "$1" != "hmce" ] && [ "$1" != "wlce" ]; then
    echo "Usage: build-fly <hmce|wlce>"
    exit 1
fi
ESCO=$1

. `dirname $0`/library.sh

# Set up some build variables
ENV=prod
GIT_COMMIT=`getGitCommit`
BUILD_FLUTTER_VERSION=`getFlutterVersion`
APP_VERSION=`getAppVersion`
NEW_BUILD_NUMBER=`incrementBuildNumber`
NEW_APP_VERSION="$APP_VERSION+$NEW_BUILD_NUMBER"

THIS_PROJECT=`pwd`/`dirname $0`/..

# Copy code to a temp build directory
BUILD_HOME=/tmp/myenergy-fly-build-`date +'%s'`
mkdir $BUILD_HOME
echo "BUILD_HOME: $BUILD_HOME"

cp -rf $THIS_PROJECT/app/* $BUILD_HOME/.
cd $BUILD_HOME

# Set version and build number
echo "\nSetting pubspec.yaml version to '$NEW_APP_VERSION'"
sed -i -e 's/^version:.*/version: '"$NEW_APP_VERSION"'/' $BUILD_HOME/pubspec.yaml

# Build web app
echo "\nBuilding for web ...\n"
# --source-maps added for sentry
flutter build web \
    --source-maps \
    --pwa-strategy none \
    --dart-define=ENV=$ENV \
    --dart-define=BUILD_FLUTTER_VERSION=$BUILD_FLUTTER_VERSION \
    --dart-define=GIT_COMMIT=$GIT_COMMIT \
    --dart-define=APP_VERSION=$NEW_APP_VERSION || exit 1

echo "\nInject build number into script hrefs for cache busting ..."
cd build/web
sed -i -e 's/v=123/v='${NEW_BUILD_NUMBER}/g index.html || exit 1
cd - > /dev/null

echo "\nEmbedding source content into sourcemap for Sentry ..."
python3 $THIS_PROJECT/bin/embed-sources.py $BUILD_HOME/build/web/main.dart.js.map $BUILD_HOME || exit 1

# Copy build artifacts and Docker files to project root for deployment
echo "\nCopying build artifacts to $THIS_PROJECT for Fly.io deployment ..."

# Clean up any previous build
rm -rf $THIS_PROJECT/build/web

# Copy the build output
mkdir -p $THIS_PROJECT/build
cp -r $BUILD_HOME/build/web $THIS_PROJECT/build/.

# Copy the favicons
cp $THIS_PROJECT/assets/$ESCO/favicon* $THIS_PROJECT/build/web/.

echo "\n=========================================="
echo "Build complete for $ESCO esco!"
echo ""
echo "Build number: $NEW_BUILD_NUMBER"
echo "App version: $NEW_APP_VERSION"
echo "Git commit: $GIT_COMMIT"
echo "Flutter Version: $BUILD_FLUTTER_VERSION"
echo "=========================================="
echo ""
echo "To deploy to Fly.io, run:"
echo "  fly deploy --config fly/fly.$ESCO.toml"
echo ""
echo "Build artifacts are in: $THIS_PROJECT/build/web"
echo "Temporary build directory: $BUILD_HOME"
echo ""
